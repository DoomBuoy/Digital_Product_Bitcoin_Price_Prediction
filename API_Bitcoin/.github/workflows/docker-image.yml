name: Bitcoin API - Build & Deploy to Render

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Generate requirements.txt
      run: |
        # Create requirements.txt for Docker build
        cat > requirements.txt << EOF
        scikit-learn==1.5.1
        pandas==2.2.2
        jupyterlab==4.2.3
        fastapi[standard]>=0.118.3,<0.119.0
        uvicorn==0.30.1
        joblib==1.4.2
        streamlit==1.36.0
        xgboost==2.1.0
        hyperopt==0.2.7
        lightgbm==4.4.0
        lime==0.2.0.1
        wandb==0.17.4
        EOF
        echo "âœ… requirements.txt generated for Docker build"
      
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: Log in to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}
        
    - name: Build and push Docker image
      id: build
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./Dockerfile
        push: true
        tags: |
          ${{ secrets.DOCKERHUB_USERNAME }}/bitcoin-prediction-api:latest
          ${{ secrets.DOCKERHUB_USERNAME }}/bitcoin-prediction-api:${{ github.sha }}
        labels: |
          org.opencontainers.image.source=https://github.com/${{ github.repository }}
          org.opencontainers.image.revision=${{ github.sha }}
          org.opencontainers.image.created=${{ steps.meta.outputs.created }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
        
    - name: Image digest
      run: echo "Image pushed with digest - ${{ steps.build.outputs.digest }}"

  test-api:
    runs-on: ubuntu-latest
    needs: build-and-push
    if: github.event_name == 'push' && github.ref == 'refs/heads/master'
    
    steps:
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11.4'
        
    - name: Install test dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests
        
    - name: Wait for Docker Hub propagation
      run: sleep 45
      
    - name: Test Docker image
      env:
        DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
      run: |
        echo "ðŸ§ª Testing Docker image from Docker Hub..."
        
        # Pull and run the latest image
        docker pull ${DOCKERHUB_USERNAME}/bitcoin-prediction-api:latest
        docker run -d -p 8000:8000 --name test-api ${DOCKERHUB_USERNAME}/bitcoin-prediction-api:latest
        
        # Wait for container to fully start
        echo "â³ Waiting for API to start..."
        sleep 20
        
        # Check if container is running
        if ! docker ps | grep -q test-api; then
          echo "âŒ Container failed to start"
          docker logs test-api
          exit 1
        fi
        
        # Test the API endpoints
        echo "ðŸ” Testing API endpoints..."
        
        # Test health endpoint
        if curl -f http://localhost:8000/health/; then
          echo "âœ… Health endpoint working"
        else
          echo "âŒ Health endpoint failed"
          docker logs test-api
          exit 1
        fi
        
        # Test root endpoint
        if curl -f http://localhost:8000/; then
          echo "âœ… Root endpoint working"
        else
          echo "âŒ Root endpoint failed"
          exit 1
        fi
        
        # Test prediction endpoint
        if curl -f "http://localhost:8000/predict/Bitcoin?date=2023-01-01"; then
          echo "âœ… Prediction endpoint working"
        else
          echo "âŒ Prediction endpoint failed"
          exit 1
        fi
        
        echo "ðŸŽ‰ All API tests passed!"
        
        # Clean up
        docker stop test-api
        docker rm test-api

  trigger-render-deployment:
    runs-on: ubuntu-latest
    needs: [build-and-push, test-api]
    if: github.ref == 'refs/heads/master' && needs.build-and-push.result == 'success'
    
    steps:
    - name: Trigger Render Auto-Deploy
      run: |
        echo "ðŸš€ Docker image pushed to Docker Hub successfully!"
        echo "ðŸ”„ Render will automatically detect the new image and redeploy"
        echo "ðŸ“¡ Monitor your Render dashboard for deployment status"
        echo ""
        echo "ðŸ³ New image available at:"
        echo "   docker pull ${{ secrets.DOCKERHUB_USERNAME }}/bitcoin-prediction-api:latest"
        echo ""
        echo "ðŸŒ Your Bitcoin API will be updated on Render shortly!"

  notify-status:
    runs-on: ubuntu-latest
    needs: [build-and-push, test-api, trigger-render-deployment]
    if: always()
    
    steps:
    - name: Deployment Summary
      env:
        BUILD_STATUS: ${{ needs.build-and-push.result }}
        TEST_STATUS: ${{ needs.test-api.result }}
        DEPLOY_STATUS: ${{ needs.trigger-render-deployment.result }}
      run: |
        echo "ðŸ“Š Bitcoin API Deployment Summary"
        echo "=================================="
        echo "ðŸ”¨ Build & Push: $BUILD_STATUS"
        echo "ðŸ§ª API Tests: $TEST_STATUS" 
        echo "ðŸš€ Render Deploy: $DEPLOY_STATUS"
        echo ""
        
        if [[ "$BUILD_STATUS" == "success" && "$TEST_STATUS" == "success" ]]; then
          echo "âœ… SUCCESS: Bitcoin API deployed successfully!"
          echo "ðŸ³ Docker Hub: ${{ secrets.DOCKERHUB_USERNAME }}/bitcoin-prediction-api:latest"
          echo "ðŸŒ Render: Check your Render dashboard for deployment status"
          echo ""
          echo "ðŸ“‹ Next Steps:"
          echo "â€¢ Monitor Render deployment in your dashboard"
          echo "â€¢ Test your live API once Render deployment completes"
          echo "â€¢ Update your API documentation with the new Render URL"
        else
          echo "âŒ FAILURE: Deployment encountered issues"
          echo "ðŸ” Check the failed jobs above for details"
          exit 1
        fi
